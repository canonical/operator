# To update the list of charms included here, run:
# python .github/update-published-charms-tests-workflow.py

name: Broad Charm Compatibility Tests

on:
  schedule:
    - cron: '0 1 25 * *'
  workflow_dispatch:

permissions: {}

jobs:
  build-wheels:
    uses: ./.github/workflows/_build-wheels.yaml

  charm-tests:
    runs-on: ubuntu-latest
    needs: build-wheels
    strategy:
      fail-fast: false
      matrix:
        include:
# BEGIN AUTOGENERATED CONTENT
          - charm-repo: canonical/admission-webhook-operator
            charm-root: .
          - charm-repo: canonical/airbyte-k8s-operator
            charm-root: .
          - charm-repo: canonical/aproxy-operator
            charm-root: .
          - charm-repo: canonical/argo-operators
            charm-root: charms/argo-controller
          - charm-repo: canonical/catalogue-k8s-operator
            charm-root: .
          - charm-repo: canonical/charm-ubuntu
            charm-root: .
          - charm-repo: canonical/conserver-charm
            charm-root: .
          - charm-repo: canonical/content-cache-k8s-operator
            charm-root: .
          - charm-repo: canonical/dex-auth-operator
            charm-root: .
          - charm-repo: canonical/digest-squid-auth-helper
            charm-root: .
          - charm-repo: canonical/discourse-k8s-operator
            charm-root: .
          - charm-repo: canonical/glauth-k8s-operator
            charm-root: .
          - charm-repo: canonical/grafana-agent-k8s-operator
            charm-root: .
          - charm-repo: canonical/hardware-observer-operator
            charm-root: .
          - charm-repo: canonical/hockeypuck-k8s-operator
            charm-root: .
          - charm-repo: canonical/httprequest-lego-provider
            charm-root: .
          - charm-repo: canonical/hydra-operator
            charm-root: .
          - charm-repo: canonical/identity-platform-login-ui-operator
            charm-root: .
          - charm-repo: canonical/indico-operator
            charm-root: .
          - charm-repo: canonical/jenkins-agent-k8s-operator
            charm-root: .
          - charm-repo: canonical/jenkins-agent-operator
            charm-root: .
          - charm-repo: canonical/jimm
            charm-root: charms/jimm
          - charm-repo: canonical/k8s-operator
            charm-root: charms/worker
          - charm-repo: canonical/k8s-operator
            charm-root: charms/worker/k8s
          - charm-repo: canonical/kafka-k8s-operator
            charm-root: .
          - charm-repo: canonical/kafka-operator
            charm-root: .
          - charm-repo: canonical/katib-operators
            charm-root: charms/katib-controller
          - charm-repo: canonical/katib-operators
            charm-root: charms/katib-db-manager
          - charm-repo: canonical/katib-operators
            charm-root: charms/katib-ui
          - charm-repo: canonical/kfp-operators
            charm-root: charms/kfp-api
          - charm-repo: canonical/kfp-operators
            charm-root: charms/kfp-metadata-writer
          - charm-repo: canonical/kfp-operators
            charm-root: charms/kfp-persistence
          - charm-repo: canonical/kfp-operators
            charm-root: charms/kfp-profile-controller
          - charm-repo: canonical/kfp-operators
            charm-root: charms/kfp-schedwf
          - charm-repo: canonical/kfp-operators
            charm-root: charms/kfp-ui
          - charm-repo: canonical/kfp-operators
            charm-root: charms/kfp-viewer
          - charm-repo: canonical/kfp-operators
            charm-root: charms/kfp-viz
          - charm-repo: canonical/kratos-external-idp-integrator
            charm-root: .
          - charm-repo: canonical/kratos-operator
            charm-root: .
          - charm-repo: canonical/kubeflow-profiles-operator
            charm-root: .
          - charm-repo: canonical/kubeflow-volumes-operator
            charm-root: .
          - charm-repo: canonical/kyuubi-k8s-operator
            charm-root: .
          - charm-repo: canonical/lego-operator
            charm-root: .
          - charm-repo: canonical/livepatch-k8s-operator
            charm-root: .
          - charm-repo: canonical/loki-k8s-operator
            charm-root: .
          - charm-repo: canonical/manual-tls-certificates-operator
            charm-root: .
          - charm-repo: canonical/mongodb-k8s-operator
            charm-root: .
          - charm-repo: canonical/mongodb-operator
            charm-root: .
          - charm-repo: canonical/mysql-router-operators
            charm-root: machines
          - charm-repo: canonical/mysql-router-operators
            charm-root: kubernetes
          - charm-repo: canonical/netbox-k8s-operator
            charm-root: .
          - charm-repo: canonical/nginx-ingress-integrator-operator
            charm-root: .
          - charm-repo: canonical/notebook-operators
            charm-root: charms/jupyter-controller
          - charm-repo: canonical/notebook-operators
            charm-root: charms/jupyter-ui
          - charm-repo: canonical/oauth2-proxy-k8s-operator
            charm-root: .
          - charm-repo: canonical/oidc-gatekeeper-operator
            charm-root: .
          - charm-repo: canonical/openfga-operator
            charm-root: .
          - charm-repo: canonical/openstack-exporter-operator
            charm-root: .
          - charm-repo: canonical/parca-agent-operator
            charm-root: .
          - charm-repo: canonical/parca-k8s-operator
            charm-root: .
          - charm-repo: canonical/parca-scrape-target-operator
            charm-root: .
          - charm-repo: canonical/pgbouncer-k8s-operator
            charm-root: .
          - charm-repo: canonical/pgbouncer-operator
            charm-root: .
          - charm-repo: canonical/ranger-k8s-operator
            charm-root: .
          - charm-repo: canonical/s3-integrator
            charm-root: .
          - charm-repo: canonical/saml-integrator-operator
            charm-root: .
          - charm-repo: canonical/seldon-core-operator
            charm-root: .
          - charm-repo: canonical/self-signed-certificates-operator
            charm-root: .
          - charm-repo: canonical/smtp-integrator-operator
            charm-root: .
          - charm-repo: canonical/spark-history-server-k8s-operator
            charm-root: .
          - charm-repo: canonical/spark-integration-hub-k8s-operator
            charm-root: .
          - charm-repo: canonical/superset-k8s-operator
            charm-root: .
          - charm-repo: canonical/tempo-operators
            charm-root: .
          - charm-repo: canonical/temporal-admin-k8s-operator
            charm-root: .
          - charm-repo: canonical/temporal-k8s-operator
            charm-root: .
          - charm-repo: canonical/temporal-ui-k8s-operator
            charm-root: .
          - charm-repo: canonical/temporal-worker-k8s-operator
            charm-root: .
          - charm-repo: canonical/traefik-k8s-operator
            charm-root: .
          - charm-repo: canonical/trino-k8s-operator
            charm-root: .
          - charm-repo: canonical/vault-k8s-operator
            charm-root: k8s
          - charm-repo: canonical/vault-k8s-operator
            charm-root: machine
          - charm-repo: canonical/wordpress-k8s-operator
            charm-root: .
          - charm-repo: canonical/zookeeper-k8s-operator
            charm-root: .
          - charm-repo: canonical/zookeeper-operator
            charm-root: .
# END AUTOGENERATED CONTENT
    steps:
      - name: Checkout operator repository (for helper scripts)
        uses: actions/checkout@v6
        with:
          path: operator-repo
          persist-credentials: false

      - name: Copy helper scripts and cleanup operator checkout
        run: |
          mkdir -p /tmp/operator-scripts
          cp operator-repo/.github/*.sh /tmp/operator-scripts/
          rm -rf operator-repo

      - name: Checkout the ${{ matrix.charm-repo }} repository
        uses: actions/checkout@v6
        with:
          repository: ${{ matrix.charm-repo }}
          path: charm-repo
          persist-credentials: false

      - name: Download operator wheels
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.build-wheels.outputs.artifact-name }}
          path: operator-wheels

      - name: Install patch dependencies
        run: pip install poetry~=2.0 uv~=0.6 tox-uv~=1.2

      - name: Set up Python 3.11 for wordpress-k8s (mysql-connector-python has no 3.12 wheels)
        if: matrix.charm-repo == 'canonical/wordpress-k8s-operator'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cap wordpress-k8s Python requirement at 3.11
        if: matrix.charm-repo == 'canonical/wordpress-k8s-operator'
        working-directory: charm-repo/${{ matrix.charm-root }}
        run: |
          set -xueo pipefail
          # Update requires-python to exclude 3.12 (mysql-connector-python compatibility)
          if [ -e "pyproject.toml" ]; then
            # For specs with a lower bound >=3.10, adjust or add an upper bound <3.12
            # Double-quoted form: replace any existing <3.X upper bound with <3.12
            sed -i -E "s/(requires-python = \">=3\.1[0-9][^\"]*),<3\.[0-9]+\"/\1,<3.12\"/" pyproject.toml
            # Double-quoted form: if there is no upper bound, append <3.12
            sed -i -E "s/(requires-python = \">=3\.1[0-9][^\"]*)\"/\1,<3.12\"/" pyproject.toml
            # Single-quoted form: replace any existing <3.X upper bound with <3.12
            sed -i -E "s/(requires-python = '>=3\.1[0-9][^']*),<3\.[0-9]+'/\1,<3.12'/" pyproject.toml
            # Single-quoted form: if there is no upper bound, append <3.12
            sed -i -E "s/(requires-python = '>=3\.1[0-9][^']*)'/\1,<3.12'/" pyproject.toml
          fi

      - name: Bump minimum Python version to align with ops requirements
        working-directory: charm-repo/${{ matrix.charm-root }}
        run: |
          set -xueo pipefail
          # Update tox.ini
          if [ -e "tox.ini" ]; then
            # Update basepython to use python3.10 if it's set to 3.8 or 3.9
            sed -i -E "s/^basepython = python3\.[89]$/basepython = python3.10/" tox.ini
            # Update py3X environment factors to py310 minimum
            sed -i -E "s/\{py3[89]\}/\{py310\}/g" tox.ini
            sed -i -E "s/\bpy3[89]\b/py310/g" tox.ini
          fi
          # Update pyproject.toml requires-python
          if [ -e "pyproject.toml" ]; then
            # Update requires-python to >=3.10 if it's <3.10 (handles >=3.8, >=3.9, >=3.8.6, etc.)
            sed -i -E "s/requires-python = \">=3\.[89](\.[0-9]+)?\"/requires-python = \">=3.10\"/" pyproject.toml
            sed -i -E "s/requires-python = '>=3\.[89](\.[0-9]+)?'/requires-python = '>=3.10'/" pyproject.toml
          fi
          # Update .python-version
          if [ -e ".python-version" ]; then
            # Replace any 3.8 or 3.9 version with 3.10
            sed -i -E "s/^3\.[89](\..*)?$/3.10/" .python-version
          fi

      - name: Update 'ops' and 'ops-scenario' dependencies in test charm to latest
        working-directory: charm-repo/${{ matrix.charm-root }}
        run: |
          set -euo pipefail
          # Get the absolute paths to the wheels
          ops_wheel="$(ls "$GITHUB_WORKSPACE"/operator-wheels/ops-[0-9]*.whl)"
          ops_scenario_wheel="$(ls "$GITHUB_WORKSPACE"/operator-wheels/ops_scenario-*.whl)"
          /tmp/operator-scripts/patch-charm-deps.sh "${ops_wheel}" "${ops_scenario_wheel}"
      - name: Install dependencies
        id: deps
        run: pip install tox~=4.2

        # The following test steps will only run if the last setup step (deps) succeeded.

      - name: Run the charm's unit tests
        if: ${{ !cancelled() && steps.deps.outcome == 'success' }}  # default behaviour if 1st step
        working-directory: charm-repo/${{ matrix.charm-root }}
        run: tox -vve unit
        env:
          # Required to allow pip to install packages that may have incompatible
          # requires-python constraints. This is necessary because we're testing
          # ops 3.x compatibility with charms that may have older Python version
          # requirements. The actual Python version in use (3.10+) is compatible
          # with ops 3.x, but some transitive dependencies may declare older
          # version requirements.
          PIP_IGNORE_REQUIRES_PYTHON: "1"

      - name: Check for tox static environment
        id: has-static
        if: ${{ !cancelled() && steps.deps.outcome == 'success' }}
        working-directory: charm-repo/${{ matrix.charm-root }}
        run: |
          set -xueo pipefail
          if tox list --no-desc | grep '^static$'; then
            echo 'static=true' >> "$GITHUB_OUTPUT"
          else
            echo 'static=false' >> "$GITHUB_OUTPUT"
          fi

      - name: Run the charm's static tests
        if: ${{ !cancelled() && steps.deps.outcome == 'success' && steps.has-static.outputs.static == 'true' }}
        working-directory: charm-repo/${{ matrix.charm-root }}
        run: tox -vve static
        env:
          # Required to allow pip to install packages that may have incompatible
          # requires-python constraints. This is necessary because we're testing
          # ops 3.x compatibility with charms that may have older Python version
          # requirements. The actual Python version in use (3.10+) is compatible
          # with ops 3.x, but some transitive dependencies may declare older
          # version requirements.
          PIP_IGNORE_REQUIRES_PYTHON: "1"


  charmcraft-profile-tests:
    runs-on: ubuntu-latest
    needs: build-wheels
    strategy:
      fail-fast: false
      matrix:
        charmcraft_channel: ["3.x/stable", "latest/edge"]
        profile: [machine, kubernetes]
        include:
          - charmcraft_channel: "3.x/stable"  # Last version to include "simple"
            profile: simple
    steps:
      - name: Install charmcraft
        run: sudo snap install charmcraft --classic --channel=${{ matrix.charmcraft_channel }}

      - name: Charmcraft init
        run: charmcraft init --profile=${{ matrix.profile }} --author=charm-tech

      - name: Download operator wheels
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.build-wheels.outputs.artifact-name }}
          path: operator-wheels

      - name: Install dependencies
        run: pip install tox~=4.2 uv~=0.9 tox-uv~=1.29

      - name: Update 'ops' and 'ops-scenario' dependencies in test charm to latest
        run: |
          set -xueo pipefail
          # Get the absolute paths to the wheels
          ops_wheel="$(ls operator-wheels/ops-[0-9]*.whl)"
          ops_scenario_wheel="$(ls operator-wheels/ops_scenario-*.whl)"
          if [ -e "requirements.txt" ]; then
            sed -i -e "/^ops[ ><=]/d" -e "/canonical\/operator/d" -e "/#egg=ops/d" requirements.txt
            sed -i -e "/^ops-scenario[ ><=]/d" -e "/^ops\[testing\][ ><=]/d" requirements.txt
            echo -e "\n${ops_wheel}" >> requirements.txt
            echo -e "\n${ops_scenario_wheel}" >> requirements.txt
          elif [ -e "uv.lock" ]; then
            uv remove ops[testing] --group unit --frozen
            uv remove ops --frozen
            uv add "${ops_wheel}" --raw-sources --prerelease=if-necessary-or-explicit
            uv add "${ops_scenario_wheel}" --group unit --raw-sources --prerelease=if-necessary-or-explicit
          else
            echo "Error: no uv.lock file found"
            exit 1
          fi

      - name: Run the charm's unit tests
        run: tox -vve unit

      - name: Run the charm's lint tests
        run: tox -vve lint

      # Charmcraft 4 doesn't have a separate 'static' environment.
      - name: Check for tox static environment
        id: has-static
        run: |
          set -xueo pipefail
          if tox list --no-desc | grep '^static$'; then
            echo 'static_exists=true' >> "$GITHUB_OUTPUT"
          else
            echo 'static_exists=false' >> "$GITHUB_OUTPUT"
          fi

      - name: Run the charm's static tests
        if: ${{ steps.has-static.outputs.static_exists == 'true' }}
        run: tox -vve static
