# To update the list of charms included here, run:
# python .github/update-published-charms-tests-workflow.py

name: Broad Charm Compatibility Tests

on:
  schedule:
    - cron: '0 1 25 * *'
  workflow_dispatch:

permissions: {}

jobs:
  charm-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
# BEGIN AUTOGENERATED CONTENT
          - charm-repo: canonical/airbyte-k8s-operator
            charm-root: .
          - charm-repo: canonical/airbyte-ui-k8s-operator
            charm-root: .
          - charm-repo: canonical/argo-operators
            charm-root: charms/argo-controller
          - charm-repo: canonical/charm-ubuntu
            charm-root: .
          - charm-repo: canonical/content-cache-k8s-operator
            charm-root: .
          - charm-repo: canonical/dex-auth-operator
            charm-root: .
          - charm-repo: canonical/digest-squid-auth-helper
            charm-root: .
          - charm-repo: canonical/discourse-k8s-operator
            charm-root: .
          - charm-repo: canonical/grafana-agent-k8s-operator
            charm-root: .
          - charm-repo: canonical/hardware-observer-operator
            charm-root: .
          - charm-repo: canonical/hydra-operator
            charm-root: .
          - charm-repo: canonical/identity-platform-login-ui-operator
            charm-root: .
          - charm-repo: canonical/indico-operator
            charm-root: .
          - charm-repo: canonical/jenkins-agent-k8s-operator
            charm-root: .
          - charm-repo: canonical/jenkins-agent-operator
            charm-root: .
          - charm-repo: canonical/jimm
            charm-root: charms/jimm
          - charm-repo: canonical/k8s-operator
            charm-root: charms/worker
          - charm-repo: canonical/k8s-operator
            charm-root: charms/worker/k8s
          - charm-repo: canonical/kafka-k8s-operator
            charm-root: .
          - charm-repo: canonical/kafka-operator
            charm-root: .
          - charm-repo: canonical/kratos-operator
            charm-root: .
          - charm-repo: canonical/kubeflow-profiles-operator
            charm-root: .
          - charm-repo: canonical/livepatch-k8s-operator
            charm-root: .
          - charm-repo: canonical/loki-k8s-operator
            charm-root: .
          - charm-repo: canonical/manual-tls-certificates-operator
            charm-root: .
          - charm-repo: canonical/mongodb-k8s-operator
            charm-root: .
          - charm-repo: canonical/mongodb-operator
            charm-root: .
          - charm-repo: canonical/mysql-router-k8s-operator
            charm-root: .
          - charm-repo: canonical/namecheap-lego-k8s-operator
            charm-root: .
          - charm-repo: canonical/nginx-ingress-integrator-operator
            charm-root: .
          - charm-repo: canonical/notebook-operators
            charm-root: charms/jupyter-controller
          - charm-repo: canonical/notebook-operators
            charm-root: charms/jupyter-ui
          - charm-repo: canonical/oathkeeper-operator
            charm-root: .
          - charm-repo: canonical/oauth2-proxy-k8s-operator
            charm-root: .
          - charm-repo: canonical/openfga-operator
            charm-root: .
          - charm-repo: canonical/openstack-exporter-operator
            charm-root: .
          - charm-repo: canonical/pgbouncer-k8s-operator
            charm-root: .
          - charm-repo: canonical/ranger-k8s-operator
            charm-root: .
          - charm-repo: canonical/route53-lego-k8s-operator
            charm-root: .
          - charm-repo: canonical/s3-integrator
            charm-root: .
          - charm-repo: canonical/saml-integrator-operator
            charm-root: .
          - charm-repo: canonical/seldon-core-operator
            charm-root: .
          - charm-repo: canonical/self-signed-certificates-operator
            charm-root: .
          - charm-repo: canonical/smtp-integrator-operator
            charm-root: .
          - charm-repo: canonical/superset-k8s-operator
            charm-root: .
          - charm-repo: canonical/temporal-admin-k8s-operator
            charm-root: .
          - charm-repo: canonical/temporal-k8s-operator
            charm-root: .
          - charm-repo: canonical/temporal-ui-k8s-operator
            charm-root: .
          - charm-repo: canonical/temporal-worker-k8s-operator
            charm-root: .
          - charm-repo: canonical/traefik-k8s-operator
            charm-root: .
          - charm-repo: canonical/trino-k8s-operator
            charm-root: .
          - charm-repo: canonical/vault-k8s-operator
            charm-root: k8s
          - charm-repo: canonical/vault-k8s-operator
            charm-root: machine
          - charm-repo: canonical/wordpress-k8s-operator
            charm-root: .
          - charm-repo: canonical/zookeeper-operator
            charm-root: .
# END AUTOGENERATED CONTENT
    steps:
      - name: Checkout the ${{ matrix.charm-repo }} repository
        uses: actions/checkout@v5
        with:
          repository: ${{ matrix.charm-repo }}
          persist-credentials: false

      - name: Install patch dependencies
        run: pip install poetry~=2.0 uv~=0.6 tox-uv~=1.2

      - name: Update 'ops' and 'ops-scenario' dependencies in test charm to latest
        working-directory: ${{ matrix.charm-root }}
        run: |
          set -xueo pipefail
          if [ -e "test-requirements.txt" ]; then
            sed -i -e "/^ops[ ><=]/d" -e "/canonical\/operator/d" -e "/#egg=ops/d" test-requirements.txt
            echo -e "\ngit+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA#egg=ops" >> test-requirements.txt
            sed -i -e "/^ops-scenario[ ><=]/d" -e "/^ops\[testing\][ ><=]/d" test-requirements.txt
            echo -e "\ngit+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA#egg=ops-scenario&subdirectory=testing" >> test-requirements.txt
          fi
          if [ -e "requirements-charmcraft.txt" ]; then
            sed -i -e "/^ops[ ><=]/d" -e "/canonical\/operator/d" -e "/#egg=ops/d" requirements-charmcraft.txt
            echo -e "\ngit+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA#egg=ops" >> requirements-charmcraft.txt
            sed -i -e "/^ops-scenario[ ><=]/d" -e "/^ops\[testing\][ ><=]/d" requirements-charmcraft.txt
            echo -e "\ngit+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA#egg=ops-scenario&subdirectory=testing" >> requirements-charmcraft.txt
          fi
          if [ -e "requirements.txt" ]; then
            sed -i -e "/^ops[ ><=]/d" -e "/canonical\/operator/d" -e "/#egg=ops/d" requirements.txt
            echo -e "\ngit+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA#egg=ops" >> requirements.txt
            sed -i -e "/^ops-scenario[ ><=]/d" -e "/^ops\[testing\][ ><=]/d" requirements.txt
            echo -e "\ngit+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA#egg=ops-scenario&subdirectory=testing" >> requirements.txt
          elif [ -e "poetry.lock" ]; then
            poetry add git+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA --lock
            poetry add git+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA#subdirectory=testing --lock
          elif [ -e "uv.lock" ]; then
            uv add --frozen --raw-sources git+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA#subdirectory=testing
            uv add --frozen --raw-sources git+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA
            uv lock
          else
            echo "Error: No requirements.txt or poetry.lock or uv.lock file found"
            exit 1
          fi

      - name: Install dependencies
        id: deps
        run: pip install tox~=4.2

        # The following test steps will only run if the last setup step (deps) succeeded.

      - name: Run the charm's unit tests
        if: ${{ !cancelled() && steps.deps.outcome == 'success' }}  # default behaviour if 1st step
        working-directory: ${{ matrix.charm-root }}
        run: tox -vve unit

      - name: Check for tox static environment
        id: has-static
        if: ${{ !cancelled() && steps.deps.outcome == 'success' }}
        working-directory: ${{ matrix.charm-root }}
        run: |
          set -xueo pipefail
          if tox list --no-desc | grep '^static$'; then
            echo 'static=true' >> "$GITHUB_OUTPUT"
          else
            echo 'static=false' >> "$GITHUB_OUTPUT"
          fi

      - name: Run the charm's static tests
        if: ${{ !cancelled() && steps.deps.outcome == 'success' && steps.has-static.outputs.static == 'true' }}
        working-directory: ${{ matrix.charm-root }}
        run: tox -vve static


  charmcraft-profile-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        charmcraft_channel: ["3.x/stable", "latest/edge"]
        profile: [machine, kubernetes]
        include:
          - charmcraft_channel: "3.x/stable"  # Last version to include "simple"
            profile: simple
    steps:
      - name: Install charmcraft
        run: sudo snap install charmcraft --classic --channel=${{ matrix.charmcraft_channel }}

      - name: Charmcraft init
        run: charmcraft init --profile=${{ matrix.profile }} --author=charm-tech

      - name: Install dependencies
        run: pip install tox~=4.2 uv~=0.9 tox-uv~=1.29

      - name: Update 'ops' and 'ops-scenario' dependencies in test charm to latest
        run: |
          set -xueo pipefail
          if [ -e "requirements.txt" ]; then
            sed -i -e "/^ops[ ><=]/d" -e "/canonical\/operator/d" -e "/#egg=ops/d" requirements.txt
            sed -i -e "/^ops-scenario[ ><=]/d" -e "/^ops\[testing\][ ><=]/d" requirements.txt
            echo -e "\ngit+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA#egg=ops" >> requirements.txt
            echo -e "\ngit+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA#egg=ops-scenario&subdirectory=testing" >> requirements.txt
          elif [ -e "uv.lock" ]; then
            uv remove ops[testing] --group unit --frozen
            uv remove ops --frozen
            uv add git+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA#subdirectory=testing --group unit --raw-sources --prerelease=if-necessary-or-explicit
            uv add git+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@$GITHUB_SHA --raw-sources --prerelease=if-necessary-or-explicit
          else
            echo "Error: no uv.lock file found"
            exit 1
          fi

      - name: Run the charm's unit tests
        run: tox -vve unit

      - name: Run the charm's lint tests
        run: tox -vve lint

      # Charmcraft 4 doesn't have a separate 'static' environment.
      - name: Check for tox static environment
        id: has-static
        run: |
          set -xueo pipefail
          if tox list --no-desc | grep '^static$'; then
            echo 'static_exists=true' >> "$GITHUB_OUTPUT"
          else
            echo 'static_exists=false' >> "$GITHUB_OUTPUT"
          fi

      - name: Run the charm's static tests
        if: ${{ steps.has-static.outputs.static_exists == 'true' }}
        run: tox -vve static
